import React, { useEffect, useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { db } from '../../firebaseConfig';
import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, setDoc } from 'firebase/firestore';
import UpdateForm from '../common/UpdateForm';
import Modal from '../common/Modal';
import { 
  unifiedEntranceVariants, 
  containerVariants, 
  itemVariants, 
  buttonVariants,
  cardVariants,
  notificationVariants,
  modalVariants,
  spinnerVariants
} from '../../utils/animations';

export default function StudentManager() {
  const [students, setStudents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [newStudent, setNewStudent] = useState({ 
    name: '', 
    classId: '',
    studentCode: '',
    dateOfBirth: '',
    gender: '',
    academicYear: ''
  });
  const [editingStudent, setEditingStudent] = useState(null);
  const [processingId, setProcessingId] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
    fetchStudents();
  }, []);

  useEffect(() => {
    if (success || error) {
      const timer = setTimeout(() => {
        setSuccess('');
        setError('');
      }, 4000);
      return () => clearTimeout(timer);
    }
  }, [success, error]);

  const fetchStudents = async () => {
    setLoading(true);
    setError('');
    try {
      const querySnapshot = await getDocs(collection(db, 'students'));
      setStudents(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    } catch (err) {
      setError('L·ªói khi t·∫£i danh s√°ch h·ªçc sinh: ' + err.message);
    }
    setLoading(false);
  };

  const handleAdd = async (e) => {
    e.preventDefault();
    if (!newStudent.name.trim() || !newStudent.classId.trim()) {
      alert('T√™n h·ªçc sinh v√† m√£ l·ªõp l√† b·∫Øt bu·ªôc!');
      return;
    }
    setProcessingId('add');
    try {
      // Sinh m√£ studentId t·ª± ƒë·ªông
      const studentsRef = collection(db, 'students');
      const snapshot = await getDocs(studentsRef);
      let maxNumber = 0;
      snapshot.forEach(docSnap => {
        const id = docSnap.id;
        if (id && id.startsWith('student')) {
          const num = parseInt(id.replace('student', ''));
          if (!isNaN(num) && num > maxNumber) maxNumber = num;
        }
      });
      const nextNumber = (maxNumber + 1).toString().padStart(3, '0');
      const studentId = 'student' + nextNumber;

      const studentData = {
        fullName: newStudent.name.trim(),
        classId: newStudent.classId.trim(),
        studentCode: newStudent.studentCode.trim() || '',
        dateOfBirth: newStudent.dateOfBirth || '',
        gender: newStudent.gender || '',
        academicYear: newStudent.academicYear || '',
        createdAt: new Date()
      };
      
      await setDoc(doc(db, 'students', studentId), studentData);
      setNewStudent({ 
        name: '', 
        classId: '',
        studentCode: '',
        dateOfBirth: '',
        gender: '',
        academicYear: ''
      });
      fetchStudents();
      setSuccess('Th√™m h·ªçc sinh th√†nh c√¥ng!');
      setError('');
    } catch (err) {
      setError('L·ªói khi th√™m h·ªçc sinh: ' + err.message);
      setSuccess('');
    }
    setProcessingId(null);
  };

  const handleEdit = (stu) => {
    setEditingStudent(stu);
  };

  const handleUpdate = async () => {
    if (!editingStudent) return;
    const { id, name, ...dataToUpdate } = editingStudent;
    
    if (!dataToUpdate.fullName) {
      setError('T√™n h·ªçc sinh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
      return;
    }
    
    setProcessingId(editingStudent.id);
    try {
      console.log('üìù Updating student with data:', dataToUpdate);
      await updateDoc(doc(db, 'students', editingStudent.id), dataToUpdate);
      setEditingStudent(null);
      fetchStudents();
      setSuccess('C·∫≠p nh·∫≠t h·ªçc sinh th√†nh c√¥ng!');
      setError('');
    } catch (err) {
      console.error('‚ùå Error updating student:', err);
      setError('L·ªói khi c·∫≠p nh·∫≠t h·ªçc sinh: ' + err.message);
      setSuccess('');
    }
    setProcessingId(null);
  };

  const handleDelete = async (id) => {
    if (!window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªçc sinh n√†y?')) return;
    setProcessingId(id);
    try {
      await deleteDoc(doc(db, 'students', id));
      fetchStudents();
      setSuccess('X√≥a h·ªçc sinh th√†nh c√¥ng!');
      setError('');
    } catch (err) {
      setError('L·ªói khi x√≥a h·ªçc sinh: ' + err.message);
      setSuccess('');
    }
    setProcessingId(null);
  };

  if (loading) {
    return (
      <motion.div 
        className="App flex items-center justify-center"
        style={{ minHeight: '40vh', flexDirection: 'column', gap: 24 }}
        variants={unifiedEntranceVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div 
          className="unified-loading"
          variants={spinnerVariants}
          animate="animate"
        />
        <motion.div 
          className="unified-gradient-text"
          style={{ fontSize: 18, fontWeight: 600, textAlign: 'center' }}
          variants={unifiedEntranceVariants}
          initial="hidden"
          animate="visible"
          transition={{ delay: 0.2 }}
        >
          ƒêang t·∫£i danh s√°ch h·ªçc sinh...
        </motion.div>
      </motion.div>
    );
  }

  if (error) {
    return (
      <motion.div 
        className="unified-card text-center"
        style={{
          maxWidth: 600,
          margin: '40px auto',
          padding: '30px'
        }}
        variants={unifiedEntranceVariants}
        initial="hidden"
        animate="visible"
      >
        <motion.div
          className="unified-avatar"
          style={{ 
            width: 60, 
            height: 60, 
            margin: '0 auto 16px',
            background: 'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)',
            fontSize: 24
          }}
          variants={itemVariants}
        >
          ‚ö†Ô∏è
        </motion.div>
        <motion.h4 
          className="unified-gradient-text"
          style={{ marginBottom: 12, fontSize: 20 }}
          variants={itemVariants}
        >
          C√≥ l·ªói x·∫£y ra
        </motion.h4>
        <motion.div 
          style={{ color: '#666' }}
          variants={itemVariants}
        >
          {error}
        </motion.div>
      </motion.div>
    );
  }

  const filteredStudents = students.filter(stu =>
    (stu.fullName || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
    (stu.id || '').toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <>
      {/* Header lu√¥n tr√™n c√πng */}
      <motion.div 
        className="text-center mb-24"
        variants={itemVariants}
      >
        <motion.div
          className="unified-avatar"
          style={{ 
            width: 70, 
            height: 70, 
            margin: '0 auto 16px',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            fontSize: 28,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            borderRadius: '50%'
          }}
          variants={itemVariants}
        >
          üë®‚Äçüéì
        </motion.div>
        <motion.h4 
          className="unified-gradient-text"
          style={{ 
            margin: '0 0 8px 0',
            fontSize: 24,
            fontWeight: 700
          }}
          variants={itemVariants}
        >
          Qu·∫£n l√Ω h·ªçc sinh
        </motion.h4>
        <motion.div 
          style={{ 
            color: '#666',
            fontSize: 16
          }}
          variants={itemVariants}
        >
          {students.length} h·ªçc sinh trong h·ªá th·ªëng
        </motion.div>
      </motion.div>
      <motion.div
        className="unified-card"
        style={{
          maxWidth: 1200,
          margin: '40px auto',
          padding: '40px 30px'
        }}
        variants={unifiedEntranceVariants}
        initial="hidden"
        animate="visible"
      >
        {/* Notifications */}
        <AnimatePresence>
          {success && (
            <motion.div
              className="unified-notification success"
              variants={notificationVariants}
              initial="hidden"
              animate="visible"
              exit="exit"
            >
              <motion.span variants={itemVariants}>
                ‚úÖ {success}
              </motion.span>
            </motion.div>
          )}
          
          {error && (
            <motion.div
              className="unified-notification error"
              variants={notificationVariants}
              initial="hidden"
              animate="visible"
              exit="exit"
            >
              <motion.span variants={itemVariants}>
                ‚ùå {error}
              </motion.span>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Add Student Form */}
        <motion.div
          className="unified-card mb-24"
          style={{ padding: '24px' }}
          variants={cardVariants}
          whileHover="hover"
        >
          <motion.h5 
            className="unified-gradient-text mb-16"
            style={{ fontSize: 18, fontWeight: 600 }}
            variants={itemVariants}
          >
            üìù Th√™m h·ªçc sinh m·ªõi
          </motion.h5>
          
          <motion.form 
            onSubmit={handleAdd} 
            className="grid grid-2 gap-16"
            style={{ alignItems: 'end' }}
            variants={containerVariants}
            initial="hidden"
            animate="visible"
          >
            <motion.div variants={itemVariants}>
              <motion.label
                className="unified-input-label"
                style={{ display: 'block', fontWeight: 600, marginBottom: 8, color: '#333', fontSize: 14 }}
                variants={itemVariants}
              >
                üë§ T√™n h·ªçc sinh *
              </motion.label>
              <motion.input
                type="text"
                value={newStudent.name}
                onChange={e => setNewStudent(s => ({ ...s, name: e.target.value }))}
                placeholder="Nh·∫≠p t√™n h·ªçc sinh"
                required
                className="unified-input"
                variants={itemVariants}
              />
            </motion.div>

            <motion.div variants={itemVariants}>
              <motion.label
                className="unified-input-label"
                style={{ display: 'block', fontWeight: 600, marginBottom: 8, color: '#333', fontSize: 14 }}
                variants={itemVariants}
              >
                üìÖ Ng√†y sinh
              </motion.label>
              <motion.input
                type="date"
                value={newStudent.dateOfBirth}
                onChange={e => setNewStudent(s => ({ ...s, dateOfBirth: e.target.value }))}
                className="unified-input"
                variants={itemVariants}
              />
            </motion.div>

            <motion.div variants={itemVariants}>
              <motion.label
                className="unified-input-label"
                style={{ display: 'block', fontWeight: 600, marginBottom: 8, color: '#333', fontSize: 14 }}
                variants={itemVariants}
              >
                üë• Gi·ªõi t√≠nh
              </motion.label>
              <motion.select
                value={newStudent.gender}
                onChange={e => setNewStudent(s => ({ ...s, gender: e.target.value }))}
                className="unified-input"
                style={{ background: 'white' }}
                variants={itemVariants}
              >
                <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
                <option value="Kh√°c">Kh√°c</option>
              </motion.select>
            </motion.div>

            <motion.div variants={itemVariants}>
              <motion.label
                className="unified-input-label"
                style={{ display: 'block', fontWeight: 600, marginBottom: 8, color: '#333', fontSize: 14 }}
                variants={itemVariants}
              >
                üéì Ni√™n kh√≥a
              </motion.label>
              <motion.input
                type="text"
                value={newStudent.academicYear}
                onChange={e => setNewStudent(s => ({ ...s, academicYear: e.target.value }))}
                placeholder="VD: 2023-2024"
                className="unified-input"
                variants={itemVariants}
              />
            </motion.div>

            <motion.div variants={itemVariants}>
              <motion.label
                className="unified-input-label"
                style={{ display: 'block', fontWeight: 600, marginBottom: 8, color: '#333', fontSize: 14 }}
                variants={itemVariants}
              >
                üè´ M√£ l·ªõp *
              </motion.label>
              <motion.input
                type="text"
                value={newStudent.classId}
                onChange={e => setNewStudent(s => ({ ...s, classId: e.target.value }))}
                placeholder="Nh·∫≠p m√£ l·ªõp"
                required
                className="unified-input"
                variants={itemVariants}
              />
            </motion.div>

            <motion.button 
              type="submit" 
              disabled={processingId === 'add'} 
              className="unified-button"
              variants={buttonVariants}
              whileHover="hover"
              whileTap="tap"
              style={{ minHeight: '48px' }}
            >
              {processingId === 'add' ? (
                <motion.div
                  className="flex items-center gap-8"
                  variants={itemVariants}
                >
                  <motion.div 
                    className="unified-loading"
                    style={{ width: 16, height: 16, borderWidth: 2 }}
                    variants={spinnerVariants}
                    animate="animate"
                  />
                  <motion.span variants={itemVariants}>
                    ƒêang th√™m...
                  </motion.span>
                </motion.div>
              ) : (
                <motion.span variants={itemVariants}>
                  ‚ûï Th√™m h·ªçc sinh
                </motion.span>
              )}
            </motion.button>
          </motion.form>
        </motion.div>

        {/* Students List */}
        <motion.div 
          className="mb-24"
          variants={itemVariants}
        >
          <motion.h5 
            className="unified-gradient-text"
            style={{ 
              margin: '0 0 16px 0',
              fontSize: 18,
              fontWeight: 600
            }}
            variants={itemVariants}
          >
            üìã Danh s√°ch h·ªçc sinh
          </motion.h5>
        </motion.div>

        <div style={{ display: 'flex', justifyContent: 'center', margin: '0 0 24px 0' }}>
          <div style={{ position: 'relative', width: 400 }}>
            <span style={{
              position: 'absolute',
              left: 18,
              top: '50%',
              transform: 'translateY(-50%)',
              color: '#667eea',
              fontSize: 24,
              pointerEvents: 'none'
            }}>üîç</span>
            <input
              type="text"
              placeholder="T√¨m ki·∫øm h·ªçc sinh..."
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              style={{
                width: '100%',
                padding: '14px 20px 14px 54px',
                borderRadius: 28,
                border: '1.5px solid #e2e8f0',
                fontSize: 18,
                boxShadow: '0 2px 8px rgba(102,126,234,0.06)',
                outline: 'none',
                transition: 'border 0.2s',
              }}
            />
          </div>
        </div>

        <motion.div
          className="grid grid-2 gap-16"
          variants={containerVariants}
          initial="hidden"
          animate="visible"
        >
          {filteredStudents.length === 0 ? (
            <motion.div
              className="text-center"
              style={{
                gridColumn: '1 / -1',
                padding: '40px 20px',
                color: '#666',
                background: 'rgba(255,255,255,0.5)',
                borderRadius: 16,
                border: '2px dashed #e2e8f0'
              }}
              variants={itemVariants}
            >
              <motion.div 
                className="unified-avatar"
                style={{ width: 64, height: 64, margin: '0 auto 16px', fontSize: 48 }}
                variants={itemVariants}
              >
                üì≠
              </motion.div>
              <motion.div 
                style={{ fontSize: 16, fontWeight: 500 }}
                variants={itemVariants}
              >
                Ch∆∞a c√≥ h·ªçc sinh n√†o
              </motion.div>
              <motion.div 
                style={{ fontSize: 14, marginTop: 8 }}
                variants={itemVariants}
              >
                H√£y th√™m h·ªçc sinh ƒë·∫ßu ti√™n
              </motion.div>
            </motion.div>
          ) : filteredStudents.map(stu => (
            <motion.div
              key={stu.id}
              className="unified-list-item"
              variants={itemVariants}
              whileHover="hover"
              style={{ padding: '20px' }}
            >
              <motion.div 
                className="mb-16"
                variants={itemVariants}
              >
                <motion.div 
                  style={{ 
                    fontWeight: 700, 
                    color: '#667eea', 
                    fontSize: 18,
                    marginBottom: 8
                  }}
                  variants={itemVariants}
                >
                  {stu.fullName || stu.name || stu.id}
                </motion.div>
                
                <motion.div
                  className="grid grid-2 gap-8"
                  style={{ fontSize: 14, color: '#4a5568' }}
                  variants={itemVariants}
                >
                  <motion.div variants={itemVariants}>
                    <span style={{ fontWeight: 600, color: '#2d3748' }}>üÜî M√£ HS:</span> {stu.id}
                  </motion.div>
                  <motion.div variants={itemVariants}>
                    <span style={{ fontWeight: 600, color: '#2d3748' }}>üè´ L·ªõp:</span> {stu.classId}
                  </motion.div>
                  <motion.div variants={itemVariants}>
                    <span style={{ fontWeight: 600, color: '#2d3748' }}>üìÖ Ng√†y sinh:</span> {stu.dateOfBirth ? new Date(stu.dateOfBirth).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥'}
                  </motion.div>
                  <motion.div variants={itemVariants}>
                    <span style={{ fontWeight: 600, color: '#2d3748' }}>üë• Gi·ªõi t√≠nh:</span> {stu.gender || 'Ch∆∞a c√≥'}
                  </motion.div>
                  <motion.div 
                    style={{ gridColumn: '1 / -1' }}
                    variants={itemVariants}
                  >
                    <span style={{ fontWeight: 600, color: '#2d3748' }}>üéì Ni√™n kh√≥a:</span> {stu.academicYear || 'Ch∆∞a c√≥'}
                  </motion.div>
                </motion.div>
              </motion.div>
              
              <motion.div 
                className="flex gap-8"
                variants={itemVariants}
              >
                <motion.button 
                  onClick={() => handleEdit(stu)} 
                  className="unified-button"
                  style={{
                    background: 'linear-gradient(135deg, #38b2ac 0%, #319795 100%)',
                    padding: '8px 16px',
                    fontSize: 12,
                    flex: 1
                  }}
                  variants={buttonVariants}
                  whileHover="hover"
                  whileTap="tap"
                >
                  ‚úèÔ∏è S·ª≠a
                </motion.button>
                <motion.button 
                  onClick={() => handleDelete(stu.id)} 
                  disabled={processingId === stu.id} 
                  className="unified-button"
                  style={{
                    background: 'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)',
                    padding: '8px 16px',
                    fontSize: 12,
                    flex: 1
                  }}
                  variants={buttonVariants}
                  whileHover="hover"
                  whileTap="tap"
                >
                  {processingId === stu.id ? (
                    <motion.div
                      className="unified-loading"
                      style={{ width: 16, height: 16, borderWidth: 2 }}
                      variants={spinnerVariants}
                      animate="animate"
                    />
                  ) : (
                    'üóëÔ∏è X√≥a'
                  )}
                </motion.button>
              </motion.div>
            </motion.div>
          ))}
        </motion.div>

        {/* Edit Modal */}
        <AnimatePresence>
          {editingStudent && (
            <motion.div
              className="unified-modal"
              variants={modalVariants}
              initial="hidden"
              animate="visible"
              exit="exit"
              onClick={() => setEditingStudent(null)}
            >
              <motion.div
                className="unified-modal-content"
                onClick={(e) => e.stopPropagation()}
              >
                <h3 className="unified-gradient-text mb-16">‚úèÔ∏è Ch·ªânh S·ª≠a H·ªçc Sinh</h3>
                <UpdateForm
                  data={editingStudent}
                  onChange={setEditingStudent}
                  onSubmit={handleUpdate}
                  onCancel={() => setEditingStudent(null)}
                  loading={processingId === editingStudent.id}
                  fields={[
                    { key: 'fullName', label: 'T√™n h·ªçc sinh', type: 'text', required: true },
                    { key: 'studentCode', label: 'M√£ h·ªçc sinh', type: 'text' },
                    { key: 'classId', label: 'M√£ l·ªõp', type: 'text', required: true },
                    { key: 'dateOfBirth', label: 'Ng√†y sinh', type: 'date' },
                    { key: 'gender', label: 'Gi·ªõi t√≠nh', type: 'select', options: [
                      { value: '', label: 'Ch·ªçn gi·ªõi t√≠nh' },
                      { value: 'Nam', label: 'Nam' },
                      { value: 'N·ªØ', label: 'N·ªØ' },
                      { value: 'Kh√°c', label: 'Kh√°c' }
                    ]},
                    { key: 'academicYear', label: 'Ni√™n kh√≥a', type: 'text' }
                  ]}
                />
              </motion.div>
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>
    </>
  );
} 